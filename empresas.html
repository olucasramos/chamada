<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Empresas & Obras - Controle de Presenças</title>
  <style>
    :root {
      /* Cores de base do projeto */
      --primary: #1e40af;
      --primary-dark: #1e3a8a;
      --primary-light: #3b82f6;
      --secondary: #06b6d4;
      --accent: #2ecc71; /* Cor de destaque para sucesso/ação */
      --success: #27ae60;
      --warning: #f1c40f;
      --danger: #dc2626;
      
      /* Efeitos de Glassmorphism */
      --surface: rgba(255, 255, 255, 0.1);
      --surface-hover: rgba(255, 255, 255, 0.15);
      --surface-card: rgba(255, 255, 255, 0.12);
      
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.8);
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      --shadow-hover: 0 20px 40px rgba(0, 0, 0, 0.3);
      --border-radius: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      /* PADRÃO VISUAL: Gradiente de fundo do index.html */
      background: linear-gradient(135deg, #2980b9, #6dd5fa, #74ebd5);
      background-attachment: fixed;
      color: var(--text-primary);
      margin: 0;
      min-height: 100vh;
      /* CORREÇÃO: Aumentado padding inferior para evitar sobreposição do rodapé */
      padding: 20px 15px 100px 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      overflow-x: hidden;
    }

    /* Elementos decorativos (bolhas) */
    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      animation: float 25s ease-in-out infinite;
      pointer-events: none;
      z-index: -1;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-15px) rotate(3deg); }
    }

    header {
      width: 100%;
      max-width: 700px;
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      animation: slideInDown 0.6s ease-out;
    }

    .btn-voltar {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(21, 67, 96, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      text-decoration: none;
      padding: 12px 18px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      box-shadow: 0 8px 25px rgba(0,0,0,0.4);
      transition: var(--transition);
    }

    .btn-voltar:hover {
      background: rgba(14, 42, 72, 0.95);
      transform: translateY(-2px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.6);
    }

    .header-title {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(135deg, #ffffff, #e0e7ff);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
      flex: 1;
    }

    /* Layout principal para formulário e lista lado a lado em telas maiores */
    .main-grid {
      width: 100%;
      max-width: 700px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 32px;
    }

    @media (min-width: 768px) {
      .main-grid {
        grid-template-columns: 2fr 3fr; /* Formulário menor, lista maior */
      }
    }

    /* Formulário de Cadastro */
    .form-section {
      animation: slideInUp 0.6s ease-out 0.1s both;
    }

    .form-card {
      background: var(--surface-card);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: var(--shadow);
      position: relative;
    }

    .form-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--secondary));
    }

    .form-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: var(--surface);
      backdrop-filter: blur(10px);
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
      transition: var(--transition);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.3);
      background: var(--surface-hover);
    }

    .form-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--success));
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 700;
      color: white;
      border: none;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: var(--transition);
      width: 100%;
      margin-top: 10px;
      position: relative;
      overflow: hidden;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-secondary {
        background: var(--surface);
        color: var(--text-primary);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 8px 15px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        margin-top: 10px;
    }

    .btn-secondary:hover {
        background: var(--surface-hover);
        transform: translateY(-1px);
    }

    /* Lista de Empresas e Obras */
    .list-section {
      animation: fadeInUp 0.8s ease-out 0.3s both;
    }

    .list-header {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--text-primary);
      text-align: center;
    }
    
    .empresa-card {
        background: var(--surface-card);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: var(--border-radius);
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: var(--shadow);
        transition: var(--transition);
        position: relative;
    }
    
    .empresa-card:hover {
        transform: translateY(-2px);
        background: var(--surface-hover);
        box-shadow: var(--shadow-hover);
    }
    
    .empresa-info {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .empresa-icon {
        font-size: 1.8rem;
        color: var(--accent);
    }
    
    .empresa-nome {
        font-size: 1.4rem;
        font-weight: 700;
        line-height: 1.2;
    }
    
    .obras-list-title {
        font-size: 1rem;
        font-weight: 600;
        margin-top: 20px;
        margin-bottom: 10px;
        color: var(--secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 5px;
    }
    
    .obra-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        font-size: 0.95rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .obra-item:last-child {
        border-bottom: none;
    }
    
    .obra-actions {
        display: flex;
        gap: 8px;
    }

    .obra-actions button {
        background: var(--surface);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text-primary);
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .obra-actions button:hover {
        background: var(--surface-hover);
        transform: translateY(-1px);
    }
    
    .obra-actions .btn-delete {
        background: var(--danger);
        border-color: var(--danger);
    }
    
    .obra-actions .btn-delete:hover {
        background: #b91c1c;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .empty-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Loading state */
    .loading {
      position: relative;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.error {
      background: var(--danger);
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(21, 67, 96, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      color: #ddd;
      text-align: center;
      font-size: 0.9rem;
      padding: 12px 0;
      font-weight: 500;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
    }

    /* Animações */
    @keyframes slideInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Responsividade */
    @media (max-width: 480px) {
      body {
        /* CORREÇÃO: Aumentado padding inferior para mobile */
        padding: 15px 10px 100px 10px;
      }

      .form-card, .empresa-card {
        padding: 20px;
      }
      
      .main-grid {
        gap: 24px;
      }
    }

    /* Estados de foco */
    .btn-primary:focus-visible,
    .btn-secondary:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <header>
    <a href="index.html" class="btn-voltar" aria-label="Voltar para página inicial">
      <span>←</span> Voltar
    </a>
    <h1 class="header-title">Empresas & Obras</h1>
  </header>

  <div class="main-grid">
    <div class="form-section">
      <div class="form-card">
        <h2 class="form-title" id="formTitle">Cadastrar Nova Empresa</h2>
        
        <form id="formEmpresa" autocomplete="off">
          <input type="hidden" id="editandoEmpresaId" value="" />

          <div class="form-group">
            <label for="nomeEmpresa" class="form-label">Nome da Empresa</label>
            <input type="text" id="nomeEmpresa" class="form-input" required placeholder="Ex: Construtora Alpha" />
          </div>

          <div class="form-group">
            <label for="obraEmpresa" class="form-label">Obra (Opcional ao cadastrar a empresa)</label>
            <input type="text" id="obraEmpresa" class="form-input" placeholder="Ex: Edifício Central" />
          </div>

          <div class="form-group">
            <label for="cnpjEmpresa" class="form-label">CNPJ (Opcional)</label>
            <input type="text" id="cnpjEmpresa" class="form-input" placeholder="00.000.000/0000-00" maxlength="18" />
          </div>

          <button type="submit" class="btn-primary" id="btnSalvarEmpresa">
            <span>Salvar Empresa</span>
          </button>
          
          <button type="button" class="btn-secondary" id="btnLimparForm" style="display: none;">
            <span>Cancelar Edição</span>
          </button>
        </form>
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <h2 class="form-title">Adicionar Obra à Empresa</h2>
            <form id="formAdicionarObra" autocomplete="off">
                <div class="form-group">
                    <label for="selectEmpresa" class="form-label">Selecionar Empresa</label>
                    <select id="selectEmpresa" class="form-select" required>
                        <option value="" disabled selected>Selecione uma empresa</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="nomeObra" class="form-label">Nome da Nova Obra</label>
                    <input type="text" id="nomeObra" class="form-input" required placeholder="Ex: Loteamento Sol Nascente" />
                </div>
                <button type="submit" class="btn-primary" id="btnSalvarObra">
                    <span>Adicionar Obra</span>
                </button>
            </form>
        </div>
      </div>
    </div>

    <div class="list-section">
      <h2 class="list-header">Empresas Cadastradas</h2>
      <div id="listaEmpresas">
        </div>
    </div>
  </div>

  <footer>
    <p>Desenvolvido por Lucas Ramos Aragão</p>
  </footer>

  <script type="module">
    import { db, ref, set, get, update, remove } from "./firebase.js";

    // Elementos DOM
    const formEmpresa = document.getElementById('formEmpresa');
    const formTitle = document.getElementById('formTitle');
    const btnSalvarEmpresa = document.getElementById('btnSalvarEmpresa');
    const btnLimparForm = document.getElementById('btnLimparForm');
    const listaEmpresasDiv = document.getElementById('listaEmpresas');
    const selectEmpresa = document.getElementById('selectEmpresa');
    const formAdicionarObra = document.getElementById('formAdicionarObra');

    let empresasCache = {};
    let editandoEmpresaId = null;

    // --- Funções Utilitárias ---
    
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'error' ? 'error' : ''}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }
    
    function setLoadingState(element, loading) {
      if (loading) {
        element.classList.add('loading');
        element.disabled = true;
      } else {
        element.classList.remove('loading');
        element.disabled = false;
      }
    }

    function formatarCNPJ(cnpj) {
      return cnpj.replace(/\D/g, '')
                 .replace(/(\d{2})(\d)/, '$1.$2')
                 .replace(/(\d{3})(\d)/, '$1.$2')
                 .replace(/(\d{3})(\d)/, '$1/$2')
                 .replace(/(\d{4})(\d{1,2})$/, '$1-$2');
    }

    function limparFormulario() {
        formEmpresa.reset();
        formAdicionarObra.reset();
        formTitle.textContent = 'Cadastrar Nova Empresa';
        btnSalvarEmpresa.innerHTML = '<span>Salvar Empresa</span>';
        btnLimparForm.style.display = 'none';
        editandoEmpresaId = null;
        document.getElementById('editandoEmpresaId').value = '';
    }

    // --- CRUD Principal (Empresas) ---

    async function carregarEmpresas() {
      try {
        const snapshot = await get(ref(db, 'empresas'));
        if (snapshot.exists()) {
          empresasCache = snapshot.val();
          montarLista();
          preencherSelectEmpresas();
        } else {
          empresasCache = {};
          montarLista();
          preencherSelectEmpresas();
        }
      } catch (error) {
        console.error('Erro ao carregar empresas:', error);
        showToast('Erro ao carregar empresas', 'error');
      }
    }

    function preencherSelectEmpresas() {
        selectEmpresa.innerHTML = '<option value="" disabled selected>Selecione uma empresa</option>';
        
        const empresasOrdenadas = Object.entries(empresasCache)
            .sort(([, a], [, b]) => (a.nome || '').localeCompare(b.nome || '', 'pt-BR', { sensitivity: 'base' }));

        empresasOrdenadas.forEach(([id, emp]) => {
            selectEmpresa.innerHTML += `<option value="${id}">${emp.nome}</option>`;
        });
    }

    async function salvarEmpresa(e) {
      e.preventDefault();
      setLoadingState(btnSalvarEmpresa, true);

      try {
        const nomeEmpresa = document.getElementById('nomeEmpresa').value.trim();
        const obraEmpresa = document.getElementById('obraEmpresa').value.trim();
        const cnpjEmpresa = document.getElementById('cnpjEmpresa').value.trim();
        const id = document.getElementById('editandoEmpresaId').value;
        
        if (!nomeEmpresa) {
          showToast('O nome da empresa é obrigatório.', 'error');
          return;
        }

        const dados = {
          nome: nomeEmpresa,
          cnpj: cnpjEmpresa,
        };

        if (id) {
          // Atualizar Empresa
          await update(ref(db, `empresas/${id}`), dados);
          
          // Adicionar a obra se não for vazia e ainda não existir
          if (obraEmpresa) {
              const obras = empresasCache[id].obras || {};
              const obraExistente = Object.values(obras).some(obra => obra.nome.toLowerCase() === obraEmpresa.toLowerCase());
              if (!obraExistente) {
                  const novoObraRef = ref(db, `empresas/${id}/obras`);
                  const newObraId = Date.now();
                  await set(ref(db, `empresas/${id}/obras/${newObraId}`), { nome: obraEmpresa });
              }
          }
          
          showToast('Empresa atualizada com sucesso!');
        } else {
          // Cadastrar Nova Empresa
          const novoId = Date.now();
          dados.obras = {};
          if (obraEmpresa) {
              // Adicionar a obra inicial
              dados.obras[Date.now() + 1] = { nome: obraEmpresa };
          }
          
          await set(ref(db, `empresas/${novoId}`), dados);
          showToast('Empresa cadastrada com sucesso!');
        }

        limparFormulario();
        carregarEmpresas();
      } catch (error) {
        console.error('Erro ao salvar empresa:', error);
        showToast('Erro ao salvar empresa', 'error');
      } finally {
        setLoadingState(btnSalvarEmpresa, false);
      }
    }
    
    function editarEmpresa(id) {
        const empresa = empresasCache[id];
        if (!empresa) return;

        editandoEmpresaId = id;
        document.getElementById('editandoEmpresaId').value = id;
        formTitle.textContent = `Editar Empresa: ${empresa.nome}`;
        btnSalvarEmpresa.innerHTML = '<span>Atualizar Empresa</span>';
        btnLimparForm.style.display = 'inline-block';

        document.getElementById('nomeEmpresa').value = empresa.nome || '';
        document.getElementById('cnpjEmpresa').value = empresa.cnpj || '';
        document.getElementById('obraEmpresa').value = ''; // Não carregamos obras para edição
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function excluirEmpresa(id, nome) {
        if (!confirm(`Tem certeza que deseja excluir a empresa "${nome}" e todas as suas obras? Esta ação não pode ser desfeita.`)) return;

        try {
            await remove(ref(db, `empresas/${id}`));
            showToast(`Empresa "${nome}" excluída com sucesso!`);
            limparFormulario();
            carregarEmpresas();
        } catch (error) {
            console.error('Erro ao excluir empresa:', error);
            showToast('Erro ao excluir empresa', 'error');
        }
    }


    // --- CRUD Secundário (Obras) ---
    
    async function adicionarObra(e) {
        e.preventDefault();
        setLoadingState(document.getElementById('btnSalvarObra'), true);
        
        try {
            const empresaId = selectEmpresa.value;
            const nomeObra = document.getElementById('nomeObra').value.trim();
            
            if (!empresaId || !nomeObra) {
                showToast('Selecione a empresa e digite o nome da obra.', 'error');
                return;
            }
            
            const empresa = empresasCache[empresaId];
            if (!empresa) {
                showToast('Empresa selecionada inválida.', 'error');
                return;
            }
            
            const obras = empresa.obras || {};
            const obraExistente = Object.values(obras).some(obra => (obra.nome || '').toLowerCase() === nomeObra.toLowerCase());
            
            if (obraExistente) {
                showToast(`A obra "${nomeObra}" já existe para esta empresa.`, 'error');
                return;
            }

            const newObraId = Date.now();
            await set(ref(db, `empresas/${empresaId}/obras/${newObraId}`), { nome: nomeObra });
            
            showToast(`Obra "${nomeObra}" adicionada com sucesso!`);
            formAdicionarObra.reset();
            carregarEmpresas();
            
        } catch (error) {
            console.error('Erro ao adicionar obra:', error);
            showToast('Erro ao adicionar obra', 'error');
        } finally {
            setLoadingState(document
