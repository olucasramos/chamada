<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hora Extra - Controle de Presenças</title>
<style>
  :root {
    --primary: #1e40af;
    --primary-dark: #1e3a8a;
    --primary-light: #3b82f6;
    --secondary: #06b6d4;
    --accent: #10b981;
    --success: #059669;
    --warning: #d97706;
    --danger: #dc2626;
    --surface: rgba(255, 255, 255, 0.1);
    --surface-hover: rgba(255, 255, 255, 0.15);
    --surface-card: rgba(255, 255, 255, 0.12);
    --text-primary: #ffffff;
    --text-secondary: rgba(255, 255, 255, 0.8);
    --shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    --shadow-hover: 0 20px 40px rgba(0, 0, 0, 0.3);
    --border-radius: 16px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    background-attachment: fixed;
    color: var(--text-primary);
    margin: 0;
    min-height: 100vh;
    padding: 20px 15px 80px 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    overflow-x: hidden;
  }

  /* Elementos decorativos */
  body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    animation: float 25s ease-in-out infinite;
    pointer-events: none;
    z-index: -1;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-15px) rotate(3deg); }
  }

  header {
    width: 100%;
    max-width: 500px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    animation: slideInDown 0.6s ease-out;
  }

  .btn-voltar {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--text-primary);
    text-decoration: none;
    padding: 12px 18px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.9rem;
    box-shadow: var(--shadow);
    transition: var(--transition);
  }

  .btn-voltar:hover {
    background: var(--surface-hover);
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
  }

  .header-title {
    font-size: 1.8rem;
    font-weight: 700;
    background: linear-gradient(135deg, #ffffff, #e0e7ff);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-align: center;
    flex: 1;
  }

  .date-section {
    width: 100%;
    max-width: 500px;
    margin-bottom: 32px;
    animation: slideInUp 0.6s ease-out 0.1s both;
  }

  .date-label {
    display: block;
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text-secondary);
    text-align: center;
  }

  #dataSelecionada {
    width: 100%;
    padding: 16px 20px;
    border-radius: var(--border-radius);
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: var(--surface);
    backdrop-filter: blur(20px);
    color: var(--text-primary);
    font-size: 1.1rem;
    font-weight: 600;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
    box-shadow: var(--shadow);
  }

  #dataSelecionada:hover {
    background: var(--surface-hover);
    border-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
  }

  #dataSelecionada:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
  }

  .funcionarios-container {
    width: 100%;
    max-width: 500px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    animation: fadeInUp 0.8s ease-out 0.3s both;
  }

  .funcionario-card {
    background: var(--surface-card);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: var(--border-radius);
    padding: 24px;
    box-shadow: var(--shadow);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }

  .funcionario-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(45deg, var(--warning), var(--accent));
    border-radius: 0 4px 4px 0;
  }

  .funcionario-card:hover {
    transform: translateY(-2px);
    background: var(--surface-hover);
    box-shadow: var(--shadow-hover);
  }

  .funcionario-card.active {
    border-color: var(--accent);
    background: rgba(16, 185, 129, 0.1);
  }

  .funcionario-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    cursor: pointer;
  }

  .funcionario-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--warning), var(--accent));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    font-weight: 700;
    color: white;
    text-transform: uppercase;
  }

  .funcionario-info {
    flex: 1;
  }

  .funcionario-nome {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .funcionario-tipo {
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .hora-extra-toggle {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.5);
    position: relative;
    cursor: pointer;
    transition: var(--transition);
    flex-shrink: 0;
  }

  .hora-extra-toggle.checked {
    border-color: var(--accent);
    background: var(--accent);
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
  }

  .hora-extra-toggle.checked::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 0.8rem;
    font-weight: 700;
  }

  .options-group {
    margin-top: 16px;
    padding: 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    border-left: 4px solid var(--warning);
    display: none;
    animation: slideIn 0.3s ease-out;
  }

  .options-group.show {
    display: block;
  }

  .option-section {
    margin-bottom: 16px;
  }

  .option-title {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--warning);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .option-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .option-button {
    background: var(--surface);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--text-primary);
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    user-select: none;
  }

  .option-button:hover {
    background: var(--surface-hover);
    transform: translateY(-1px);
  }

  .option-button.selected {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }

  .hours-section {
    display: none;
  }

  .hours-section.show {
    display: block;
  }

  .hours-select {
    width: 100%;
    max-width: 150px;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: var(--surface);
    color: var(--text-primary);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
  }

  .hours-select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
  }

  .btn-salvar {
    background: linear-gradient(135deg, var(--warning), var(--accent));
    padding: 18px 32px;
    border-radius: var(--border-radius);
    font-size: 1.2rem;
    font-weight: 700;
    color: white;
    border: none;
    box-shadow: var(--shadow);
    cursor: pointer;
    transition: var(--transition);
    margin: 32px auto;
    max-width: 300px;
    width: 100%;
    position: relative;
    overflow: hidden;
  }

  .btn-salvar::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }

  .btn-salvar:hover::before {
    left: 100%;
  }

  .btn-salvar:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: var(--shadow-hover);
  }

  .btn-salvar:active {
    transform: translateY(-1px) scale(1.02);
  }

  .btn-salvar:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
  }

  .empty-icon {
    font-size: 3rem;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  /* Loading state */
  .loading {
    position: relative;
  }

  .loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Toast notifications */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--success);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    z-index: 1000;
    transform: translateX(100%);
    transition: transform 0.3s ease;
  }

  .toast.show {
    transform: translateX(0);
  }

  .toast.error {
    background: var(--danger);
  }

  footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(20px);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--text-secondary);
    text-align: center;
    font-size: 0.9rem;
    padding: 16px 20px;
    font-weight: 500;
  }

  /* Animações */
  @keyframes slideInDown {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      max-height: 0;
      padding: 0 16px;
    }
    to {
      opacity: 1;
      max-height: 300px;
      padding: 16px;
    }
  }

  /* Responsividade */
  @media (max-width: 480px) {
    body {
      padding: 15px 10px 80px 10px;
    }

    .funcionario-card {
      padding: 20px 16px;
    }

    .option-buttons {
      flex-direction: column;
      gap: 8px;
    }

    .btn-salvar {
      font-size: 1.1rem;
      padding: 16px 24px;
    }
  }

  /* Estados de foco */
  .btn-salvar:focus-visible,
  .option-button:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
</style>
</head>
<body>

<header>
  <a href="index.html" class="btn-voltar" aria-label="Voltar para página inicial">
    <span>←</span> Voltar
  </a>
  <h1 class="header-title">Hora Extra</h1>
</header>

<div class="date-section">
  <label for="dataSelecionada" class="date-label">Data das Horas Extras</label>
  <input type="date" id="dataSelecionada" />
</div>

<div class="funcionarios-container" id="listaFuncionarios">
  <!-- Funcionários serão carregados aqui -->
</div>

<button class="btn-salvar" id="btnSalvar">
  <span>Salvar Horas Extras</span>
</button>

<footer>
  <p>Desenvolvido por Lucas Ramos Aragão</p>
</footer>

<script type="module">
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
import { app } from "./firebase.js";

const db = getDatabase(app);
const listaFuncionarios = document.getElementById("listaFuncionarios");
const dataSelecionadaInput = document.getElementById("dataSelecionada");
const btnSalvar = document.getElementById("btnSalvar");

let funcionarioData = {};

// Funções utilitárias
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type === 'error' ? 'error' : ''}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => toast.classList.add('show'), 100);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => document.body.removeChild(toast), 300);
  }, 3000);
}

function setLoadingState(element, loading) {
  if (loading) {
    element.classList.add('loading');
    element.disabled = true;
  } else {
    element.classList.remove('loading');
    element.disabled = false;
  }
}

function getInitials(nome) {
  return nome.split(' ').map(n => n[0]).join('').substring(0, 2);
}

// Data de hoje
function definirDataHoje() {
  const hoje = new Date();
  const yyyy = hoje.getFullYear();
  const mm = String(hoje.getMonth() + 1).padStart(2,'0');
  const dd = String(hoje.getDate()).padStart(2,'0');
  dataSelecionadaInput.value = `${yyyy}-${mm}-${dd}`;
}

// Carregar funcionários
async function carregarFuncionarios() {
  setLoadingState(btnSalvar, true);
  
  try {
    const snapshot = await get(ref(db, 'funcionarios'));
    if (snapshot.exists()) {
      const funcionarios = snapshot.val();
      montarCards(funcionarios);
    } else {
      listaFuncionarios.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">👥</div>
          <p>Nenhum funcionário encontrado.</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Erro ao carregar funcionários:', error);
    showToast('Erro ao carregar funcionários', 'error');
    listaFuncionarios.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">❌</div>
        <p>Erro ao carregar funcionários.</p>
      </div>
    `;
  } finally {
    setLoadingState(btnSalvar, false);
  }
}

// Montar cards
function montarCards(funcionarios) {
  listaFuncionarios.innerHTML = '';
  funcionarioData = {};
  
  const listaOrdenada = Object.entries(funcionarios)
    .filter(([, f]) => f.tipo && f.tipo.toLowerCase() === 'funcionario')
    .sort(([, a], [, b]) => a.nome.localeCompare(b.nome, 'pt-BR', {sensitivity:'base'}));

  if (listaOrdenada.length === 0) {
    listaFuncionarios.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">⏰</div>
        <p>Nenhum funcionário elegível para hora extra encontrado.</p>
      </div>
    `;
    return;
  }

  for (const [id, f] of listaOrdenada) {
    funcionarioData[id] = {
      nome: f.nome,
      ativo: false,
      percentual: null,
      horas: 1
    };

    const card = document.createElement('div');
    card.classList.add('funcionario-card');
    card.dataset.id = id;

    card.innerHTML = `
      <div class="funcionario-header" onclick="toggleFuncionario('${id}')">
        <div class="funcionario-avatar">${getInitials(f.nome)}</div>
        <div class="funcionario-info">
          <div class="funcionario-nome">
            ${f.nome}
            <div class="hora-extra-toggle" id="toggle_${id}"></div>
          </div>
          <div class="funcionario-tipo">Funcionário</div>
        </div>
      </div>
      
      <div class="options-group" id="options_${id}">
        <div class="option-section">
          <div class="option-title">Percentual de Hora Extra</div>
          <div class="option-buttons">
            <button class="option-button" onclick="selecionarPercentual('${id}', '100')">100%</button>
            <button class="option-button" onclick="selecionarPercentual('${id}', '50')">50%</button>
          </div>
        </div>
        
        <div class="option-section hours-section" id="hours_${id}">
          <div class="option-title">Quantidade de Horas</div>
          <select class="hours-select" onchange="selecionarHoras('${id}', this.value)">
            ${Array.from({length:12},(_,i)=>`<option value="${i+1}" ${i === 0 ? 'selected' : ''}>${i+1}h</option>`).join('')}
          </select>
        </div>
      </div>
    `;

    listaFuncionarios.appendChild(card);
  }
}

// Funções de controle
function toggleFuncionario(id) {
  const toggle = document.getElementById(`toggle_${id}`);
  const options = document.getElementById(`options_${id}`);
  const card = document.querySelector(`[data-id="${id}"]`);
  
  funcionarioData[id].ativo = !funcionarioData[id].ativo;
  
  if (funcionarioData[id].ativo) {
    toggle.classList.add('checked');
    options.classList.add('show');
    card.classList.add('active');
  } else {
    toggle.classList.remove('checked');
    options.classList.remove('show');
    card.classList.remove('active');
    
    // Reset selections
    funcionarioData[id].percentual = null;
    funcionarioData[id].horas = 1;
    
    // Clear UI
    const buttons = options.querySelectorAll('.option-button');
    buttons.forEach(btn => btn.classList.remove('selected'));
    
    const hoursSection = document.getElementById(`hours_${id}`);
    hoursSection.classList.remove('show');
  }
}

function selecionarPercentual(id, percentual) {
  const options = document.getElementById(`options_${id}`);
  const buttons = options.querySelectorAll('.option-button');
  const hoursSection = document.getElementById(`hours_${id}`);
  
  // Clear previous selections
  buttons.forEach(btn => btn.classList.remove('selected'));
  
  // Select new option
  const selectedButton = Array.from(buttons).find(btn => btn.textContent === `${percentual}%`);
  if (selectedButton) {
    selectedButton.classList.add('selected');
    funcionarioData[id].percentual = percentual;
    hoursSection.classList.add('show');
  }
}

function selecionarHoras(id, horas) {
  funcionarioData[id].horas = parseInt(horas, 10);
}

// Carregar dados salvos
async function carregarHorasExtrasData(data) {
  if (!data) return;

  try {
    const snapshot = await get(ref(db, `horaextra/${data}`));
    if (snapshot.exists()) {
      const horasExtrasDoDia = snapshot.val();
      
      for (const id in funcionarioData) {
        if (horasExtrasDoDia[id]) {
          const dados = horasExtrasDoDia[id];
          
          // Ativar funcionário
          toggleFuncionario(id);
          
          // Selecionar percentual
          if (dados.percentual) {
            selecionarPercentual(id, dados.percentual);
          }
          
          // Selecionar horas
          if (dados.quantidadeHoras) {
            const select = document.querySelector(`[data-id="${id}"] .hours-select`);
            if (select) {
              select.value = dados.quantidadeHoras;
              selecionarHoras(id, dados.quantidadeHoras);
            }
          }
        }
      }
    }
  } catch (error) {
    console.error('Erro ao carregar dados da data:', error);
    showToast('Erro ao carregar dados da data', 'error');
  }
}

// Salvar hora extra
async function salvarHorasExtras() {
  const data = dataSelecionadaInput.value;
  if (!data) {
    showToast('Selecione uma data', 'error');
    return;
  }

  setLoadingState(btnSalvar, true);

  try {
    const horasExtrasDoDia = {};
    let temRegistros = false;

    for (const id in funcionarioData) {
      const func = funcionarioData[id];
      
      if (func.ativo) {
        if (!func.percentual) {
          showToast(`Selecione o percentual para ${func.nome}`, 'error');
          return;
        }
        
        horasExtrasDoDia[id] = {
          percentual: func.percentual,
          quantidadeHoras: func.horas
        };
        temRegistros = true;
      }
    }

    if (!temRegistros) {
      showToast('Selecione pelo menos um funcionário', 'error');
      return;
    }

    await set(ref(db, `horaextra/${data}`), horasExtrasDoDia);
    showToast('Horas extras salvas com sucesso!');
  } catch (error) {
    console.error('Erro ao salvar horas extras:', error);
    showToast('Erro ao salvar horas extras', 'error');
  } finally {
    setLoadingState(btnSalvar, false);
  }
}

// Event listeners
btnSalvar.addEventListener('click', salvarHorasExtras);

dataSelecionadaInput.addEventListener('change', () => {
  if (Object.keys(funcionarioData).length > 0) {
    carregarHorasExtrasData(dataSelecionadaInput.value);
  }
});

// Tornar funções globais
window.toggleFuncionario = toggleFuncionario;
window.selecionarPercentual = selecionarPercentual;
window.selecionarHoras = selecionarHoras;

// Inicializar
async function iniciar() {
  definirDataHoje();
  await carregarFuncionarios();
  if (Object.keys(funcionarioData).length > 0) {
    carregarHorasExtrasData(dataSelecionadaInput.value);
  }
}

iniciar();
</script>

</body>
</html>
