<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Funcionários - Controle de Presenças</title>
  <style>
    :root {
      --accent: #2ecc71;
      --danger: #dc2626;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --border-radius: 12px;
      --transition: all 0.3s ease;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: #1f2937;
      color: var(--text-primary);
      margin: 0;
      min-height: 100vh;
      padding: 20px 15px 100px 15px;
    }
    .container {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }
    .btn-voltar {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      text-decoration: none;
      padding: 10px 16px;
      border-radius: var(--border-radius);
      font-weight: 600;
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .btn-voltar:hover { background-color: rgba(255, 255, 255, 0.2); }
    .header-title { font-size: 1.5rem; font-weight: 700; text-align: left; flex-grow: 1; }
    .card {
      background-color: rgba(42, 60, 80, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--border-radius);
      padding: 24px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .card-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--text-secondary);
      text-transform: uppercase;
    }
    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background-color: rgba(0, 0, 0, 0.2);
      color: var(--text-primary);
      font-size: 1rem;
      transition: var(--transition);
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.3);
    }
    .radio-group { display: flex; gap: 16px; margin-top: 8px; }
    .radio-option { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .btn {
      width: 100%;
      padding: 14px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      color: white;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      margin-top: 16px;
    }
    .btn-primary { background-color: var(--accent); }
    .btn-primary:hover { background-color: #27ae60; }
    .btn-secondary { background-color: rgba(255, 255, 255, 0.1); }
    .btn-secondary:hover { background-color: rgba(255, 255, 255, 0.2); }
    .funcionario-details p {
        margin: 0 0 8px 0;
        font-size: 0.95rem;
        color: var(--text-secondary);
    }
    .funcionario-details p strong { color: var(--text-primary); font-weight: 600; }
    .funcionario-actions {
        display: flex;
        gap: 8px;
        margin-top: 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 16px;
    }
    .filter-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media (min-width: 500px) {
      .filter-grid { grid-template-columns: 1fr 1fr; }
    }
    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
      text-align: center;
      font-size: 0.85rem;
      padding: 16px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a href="index.html" class="btn-voltar">
        <span>←</span> Voltar
      </a>
      <h1 class="header-title">Funcionários</h1>
    </header>

    <div class="card">
        <h2 class="card-title">Filtros</h2>
        <div class="filter-grid">
            <div class="form-group">
                <label for="filtroEmpresa" class="form-label">Filtrar por Empresa</label>
                <select id="filtroEmpresa" class="form-select"></select>
            </div>
            <div class="form-group">
                <label for="filtroObra" class="form-label">Filtrar por Obra</label>
                <select id="filtroObra" class="form-select" disabled></select>
            </div>
        </div>
    </div>

    <div class="card">
      <h2 class="card-title" id="formTitle">Cadastrar Funcionário</h2>
      <form id="formFuncionario" autocomplete="off">
        <div class="form-group">
          <label for="nome" class="form-label">Nome Completo</label>
          <input type="text" id="nome" class="form-input" required placeholder="Digite o nome completo" />
        </div>
        <div class="form-group">
          <label class="form-label">Tipo</label>
          <div class="radio-group">
            <label class="radio-option"><input type="radio" name="tipo" value="funcionario" checked> Funcionário</label>
            <label class="radio-option"><input type="radio" name="tipo" value="diarista"> Diarista</label>
          </div>
        </div>
        <div class="form-group">
          <label for="empresa" class="form-label">Empresa</label>
          <select id="empresa" class="form-select">
            <option value="">Nenhuma</option>
          </select>
        </div>
        <div class="form-group">
          <label for="obra" class="form-label">Obra</label>
          <select id="obra" class="form-select" disabled><option value="">Selecione uma empresa primeiro</option></select>
        </div>
        <div class="form-group">
          <label for="funcao" class="form-label">Função</label>
          <input type="text" id="funcao" class="form-input" placeholder="Ex: Ajudante, Oficial, etc."/>
        </div>
        <div id="diaristaCampos" style="display: none;">
          <div class="form-group"><label for="cpf" class="form-label">CPF</label><input type="text" id="cpf" class="form-input" placeholder="000.000.000-00" maxlength="14" /></div>
          <div class="form-group"><label for="valorDiaria" class="form-label">Valor da Diária (R$)</label><input type="number" id="valorDiaria" class="form-input" min="0" step="1" placeholder="0" /></div>
        </div>
        <button type="submit" class="btn btn-primary" id="btnSalvar">Salvar</button>
        <button type="button" class="btn btn-secondary" id="btnCancelarEdicao" style="display: none;">Cancelar Edição</button>
      </form>
    </div>

    <div id="listaFuncionarios">
      </div>
  </div>

  <footer>
    <p>Desenvolvido por Lucas Ramos Aragão</p>
  </footer>

  <script type="module">
    import { db, ref, set, get, update, remove } from "./firebase.js";

    const form = document.getElementById('formFuncionario');
    const formTitle = document.getElementById('formTitle');
    const btnSalvar = document.getElementById('btnSalvar');
    const btnCancelarEdicao = document.getElementById('btnCancelarEdicao');
    const listaFuncionarios = document.getElementById('listaFuncionarios');
    const diaristaCampos = document.getElementById('diaristaCampos');
    
    const selectEmpresaForm = document.getElementById('empresa');
    const selectObraForm = document.getElementById('obra');

    // NOVOS ELEMENTOS DO FILTRO
    const filtroEmpresa = document.getElementById('filtroEmpresa');
    const filtroObra = document.getElementById('filtroObra');

    let funcionariosCache = {};
    let empresasCache = {};
    let editandoId = null;

    function formatarCPF(cpf) {
      return (cpf || '').replace(/\D/g, '')
                .replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    }
    
    // --- LÓGICA DE EMPRESAS E OBRAS ---
    async function carregarEmpresas() {
        try {
            const snapshot = await get(ref(db, 'empresas'));
            empresasCache = snapshot.exists() ? snapshot.val() : {};
            preencherSelectEmpresas(selectEmpresaForm);
            preencherSelectFiltroEmpresa();
        } catch (error) { console.error("Erro ao carregar empresas:", error); }
    }

    function preencherSelectEmpresas(selectEl) {
        selectEl.innerHTML = '<option value="">Nenhuma</option>';
        for (const id in empresasCache) {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = empresasCache[id].nome;
            selectEl.appendChild(option);
        }
    }
    
    // NOVO: Preenche dropdown de filtro com opções especiais
    function preencherSelectFiltroEmpresa() {
        filtroEmpresa.innerHTML = `
            <option value="">Todas as Empresas</option>
            <option value="sem_empresa">Funcionários Sem Empresa</option>
        `;
        for (const id in empresasCache) {
            filtroEmpresa.innerHTML += `<option value="${id}">${empresasCache[id].nome}</option>`;
        }
    }

    function atualizarSelectObras(empresaId, selectObraEl) {
        selectObraEl.innerHTML = '';
        selectObraEl.disabled = true;

        if (!empresaId || !empresasCache[empresaId]?.obras) {
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = empresaId ? "Nenhuma obra cadastrada" : "Selecione uma empresa";
            selectObraEl.appendChild(defaultOption);
            return;
        }

        selectObraEl.disabled = false;
        // Adiciona opção "Todas as Obras" para o filtro
        const todasObrasOption = selectObraEl.id === 'filtroObra';
        const defaultOptionText = todasObrasOption ? "Todas as Obras" : "Selecione a obra";
        selectObraEl.innerHTML = `<option value="">${defaultOptionText}</option>`;

        const obras = empresasCache[empresaId].obras;
        for (const obraId in obras) {
            const option = document.createElement('option');
            option.value = obras[obraId].nome;
            option.textContent = obras[obraId].nome;
            selectObraEl.appendChild(option);
        }
    }
    
    selectEmpresaForm.addEventListener('change', () => atualizarSelectObras(selectEmpresaForm.value, selectObraForm));
    filtroEmpresa.addEventListener('change', () => atualizarSelectObras(filtroEmpresa.value, filtroObra));
    
    // --- LÓGICA DE FILTRAGEM E EXIBIÇÃO ---
    function aplicarFiltrosEExibir() {
        const empresaId = filtroEmpresa.value;
        const obraNome = filtroObra.value;
        
        const todosFuncionarios = Object.entries(funcionariosCache);
        let funcionariosFiltrados = todosFuncionarios;

        if (empresaId === 'sem_empresa') {
            funcionariosFiltrados = todosFuncionarios.filter(([id, f]) => !f.empresaId);
        } else if (empresaId) {
            funcionariosFiltrados = todosFuncionarios.filter(([id, f]) => f.empresaId === empresaId);
            if (obraNome) {
                funcionariosFiltrados = funcionariosFiltrados.filter(([id, f]) => f.obra === obraNome);
            }
        }
        
        montarLista(funcionariosFiltrados);
    }
    
    filtroEmpresa.addEventListener('change', aplicarFiltrosEExibir);
    filtroObra.addEventListener('change', aplicarFiltrosEExibir);

    // --- LÓGICA DE FUNCIONÁRIOS ---
    function toggleDiaristaCampos() {
        const tipo = document.querySelector('input[name="tipo"]:checked').value;
        diaristaCampos.style.display = tipo === 'diarista' ? 'block' : 'none';
    }
    document.querySelectorAll('input[name="tipo"]').forEach(radio => radio.addEventListener('change', toggleDiaristaCampos));

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        btnSalvar.disabled = true;
        btnSalvar.textContent = "Salvando...";

        const dadosFuncionario = {
            nome: form.nome.value.trim(),
            tipo: document.querySelector('input[name="tipo"]:checked').value,
            funcao: form.funcao.value.trim(),
            empresaId: selectEmpresaForm.value,
            obra: selectObraForm.value,
            cpf: form.cpf.value.trim(),
            valorDiaria: form.valorDiaria.value || 0,
        };

        try {
            const id = editandoId || Date.now();
            await set(ref(db, `funcionarios/${id}`), dadosFuncionario);
            alert(editandoId ? 'Funcionário atualizado!' : 'Funcionário cadastrado!');
            resetarFormulario();
            await carregarFuncionarios();
            aplicarFiltrosEExibir(); // Atualiza a lista com o novo item
        } catch (error) {
            console.error('Erro ao salvar:', error);
        } finally {
            btnSalvar.disabled = false;
            btnSalvar.textContent = "Salvar";
        }
    });
    
    async function carregarFuncionarios() {
        try {
            const snapshot = await get(ref(db, 'funcionarios'));
            funcionariosCache = snapshot.exists() ? snapshot.val() : {};
        } catch (error) { console.error('Erro ao carregar funcionários:', error); }
    }
    
    function montarLista(listaParaExibir) {
        listaFuncionarios.innerHTML = '';
        if (listaParaExibir.length === 0) {
            listaFuncionarios.innerHTML = `<div class="card" style="text-align:center; color: var(--text-secondary);"><p>Nenhum funcionário encontrado para os filtros selecionados.</p></div>`;
            return;
        }

        listaParaExibir.sort(([,a], [,b]) => (a.nome || '').localeCompare(b.nome || '')).forEach(([id, f]) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.marginBottom = '16px';
            
            const empresaNome = f.empresaId ? empresasCache[f.empresaId]?.nome || 'N/A' : 'Nenhuma';

            card.innerHTML = `
                <h3 class="card-title" style="font-size: 1.1rem;">${f.nome}</h3>
                <div class="funcionario-details">
                    <p><strong>Tipo:</strong> ${f.tipo === 'diarista' ? 'Diarista' : 'Funcionário'}</p>
                    <p><strong>Função:</strong> ${f.funcao || '-'}</p>
                    <p><strong>Empresa:</strong> ${empresaNome}</p>
                    <p><strong>Obra:</strong> ${f.obra || 'Nenhuma'}</p>
                    ${f.tipo === 'diarista' ? `<p><strong>CPF:</strong> ${formatarCPF(f.cpf)}</p><p><strong>Valor/diária:</strong> R$ ${parseFloat(f.valorDiaria || 0).toFixed(2)}</p>` : ''}
                </div>
                <div class="funcionario-actions">
                    <button class="btn btn-secondary" data-id="${id}" data-action="edit">Editar</button>
                    <button class="btn" style="background-color: var(--danger)" data-id="${id}" data-action="delete">Excluir</button>
                </div>
            `;
            listaFuncionarios.appendChild(card);
        });
    }
    
    listaFuncionarios.addEventListener('click', (e) => {
        const target = e.target;
        if (target.tagName !== 'BUTTON') return;
        
        const action = target.dataset.action;
        const id = target.dataset.id;

        if (action === 'edit') editarFuncionario(id);
        if (action === 'delete') excluirFuncionario(id);
    });

    function editarFuncionario(id) {
        const f = funcionariosCache[id];
        if (!f) return;
        editandoId = id;
        formTitle.textContent = 'Editar Funcionário';
        btnSalvar.textContent = 'Atualizar';
        btnCancelarEdicao.style.display = 'block';
        form.nome.value = f.nome;
        document.querySelector(`input[name="tipo"][value="${f.tipo}"]`).checked = true;
        toggleDiaristaCampos();
        form.funcao.value = f.funcao || '';
        form.cpf.value = f.cpf || '';
        form.valorDiaria.value = f.valorDiaria || '';
        selectEmpresaForm.value = f.empresaId || '';
        atualizarSelectObras(f.empresaId, selectObraForm);
        setTimeout(() => { selectObraForm.value = f.obra || ''; }, 100);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function excluirFuncionario(id) {
        if (!confirm(`Deseja realmente excluir "${funcionariosCache[id].nome}"?`)) return;
        try {
            await remove(ref(db, `funcionarios/${id}`));
            delete funcionariosCache[id]; // Remove do cache local
            aplicarFiltrosEExibir(); // Atualiza a lista
            alert('Funcionário excluído!');
        } catch (error) { console.error('Erro ao excluir:', error); }
    }
    
    function resetarFormulario() {
        form.reset();
        editandoId = null;
        formTitle.textContent = 'Cadastrar Funcionário';
        btnSalvar.textContent = 'Salvar';
        btnCancelarEdicao.style.display = 'none';
        toggleDiaristaCampos();
        selectEmpresaForm.value = '';
        atualizarSelectObras('', selectObraForm);
    }
    
    btnCancelarEdicao.addEventListener('click', resetarFormulario);
    document.getElementById('cpf').addEventListener('input', e => { e.target.value = formatarCPF(e.target.value); });

    async function iniciar() {
        toggleDiaristaCampos();
        await carregarEmpresas();
        await carregarFuncionarios();
        aplicarFiltrosEExibir(); // Exibe a lista inicial (todos)
    }

    iniciar();
  </script>
</body>
</html>
