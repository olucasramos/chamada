<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Funcionários - Controle de Presenças</title>
  <style>
    :root {
      --accent: #2ecc71; /* Verde para botões de ação */
      --danger: #dc2626; /* Vermelho para exclusão */
      --text-primary: #ffffff; /* Texto principal branco */
      --text-secondary: rgba(255, 255, 255, 0.7); /* Texto secundário com leve transparência */
      --border-radius: 12px;
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      /* DESIGN UNIFICADO: Fundo sólido escuro para garantir compatibilidade e contraste */
      background-color: #1f2937;
      color: var(--text-primary);
      margin: 0;
      min-height: 100vh;
      padding: 20px 15px 100px 15px;
    }

    .container {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .btn-voltar {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      text-decoration: none;
      padding: 10px 16px;
      border-radius: var(--border-radius);
      font-weight: 600;
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-voltar:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .header-title {
      font-size: 1.5rem;
      font-weight: 700;
      text-align: left;
      flex-grow: 1;
    }

    .card {
      background-color: rgba(42, 60, 80, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--border-radius);
      padding: 24px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .card-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background-color: rgba(0, 0, 0, 0.2);
      color: var(--text-primary);
      font-size: 1rem;
      transition: var(--transition);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.3);
    }

    .radio-group {
      display: flex;
      gap: 16px;
      margin-top: 8px;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      color: white;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      margin-top: 16px;
    }

    .btn-primary {
      background-color: var(--accent);
    }
    .btn-primary:hover {
      background-color: #27ae60;
    }
    
    .btn-secondary {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .btn-secondary:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    .funcionario-details p {
        margin: 0 0 8px 0;
        font-size: 0.95rem;
        color: var(--text-secondary);
    }
    .funcionario-details p strong {
        color: var(--text-primary);
        font-weight: 600;
    }

    .funcionario-actions {
        display: flex;
        gap: 8px;
        margin-top: 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 16px;
    }
    
    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
      text-align: center;
      font-size: 0.85rem;
      padding: 16px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a href="index.html" class="btn-voltar">
        <span>←</span> Voltar
      </a>
      <h1 class="header-title">Funcionários</h1>
    </header>

    <div class="card">
      <h2 class="card-title" id="formTitle">Cadastrar Funcionário</h2>
      
      <form id="formFuncionario" autocomplete="off">
        <div class="form-group">
          <label for="nome" class="form-label">Nome Completo</label>
          <input type="text" id="nome" class="form-input" required placeholder="Digite o nome completo" />
        </div>

        <div class="form-group">
          <label class="form-label">Tipo</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="tipo" value="funcionario" checked> Funcionário
            </label>
            <label class="radio-option">
              <input type="radio" name="tipo" value="diarista"> Diarista
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label for="empresa" class="form-label">Empresa</label>
          <select id="empresa" class="form-select">
            <option value="">Nenhuma</option>
          </select>
        </div>

        <div class="form-group">
          <label for="obra" class="form-label">Obra</label>
          <select id="obra" class="form-select" disabled>
            <option value="">Selecione uma empresa primeiro</option>
          </select>
        </div>
        <div class="form-group">
          <label for="funcao" class="form-label">Função</label>
          <input type="text" id="funcao" class="form-input" placeholder="Ex: Ajudante, Oficial, etc."/>
        </div>

        <div id="diaristaCampos" style="display: none;">
          <div class="form-group">
            <label for="cpf" class="form-label">CPF</label>
            <input type="text" id="cpf" class="form-input" placeholder="000.000.000-00" maxlength="14" />
          </div>

          <div class="form-group">
            <label for="valorDiaria" class="form-label">Valor da Diária (R$)</label>
            <input type="number" id="valorDiaria" class="form-input" min="0" step="1" placeholder="0" />
          </div>
        </div>

        <button type="submit" class="btn btn-primary" id="btnSalvar">
          Salvar
        </button>
        <button type="button" class="btn btn-secondary" id="btnCancelarEdicao" style="display: none;">
          Cancelar Edição
        </button>
      </form>
    </div>

    <div id="listaFuncionarios">
      </div>
  </div>

  <footer>
    <p>Desenvolvido por Lucas Ramos Aragão</p>
  </footer>

  <script type="module">
    import { db, ref, set, get, update, remove } from "./firebase.js";

    const form = document.getElementById('formFuncionario');
    const formTitle = document.getElementById('formTitle');
    const btnSalvar = document.getElementById('btnSalvar');
    const btnCancelarEdicao = document.getElementById('btnCancelarEdicao');
    const listaFuncionarios = document.getElementById('listaFuncionarios');
    const diaristaCampos = document.getElementById('diaristaCampos');
    
    // NOVOS ELEMENTOS DO DOM
    const selectEmpresa = document.getElementById('empresa');
    const selectObra = document.getElementById('obra');

    let funcionariosCache = {};
    let empresasCache = {}; // Cache para empresas e obras
    let editandoId = null;

    // --- Funções Utilitárias ---
    function showToast(message, type = 'success') {
      // (seu código de toast aqui, se precisar)
      alert(message);
    }

    function formatarCPF(cpf) {
      return (cpf || '').replace(/\D/g, '')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    }
    
    // --- LÓGICA DE EMPRESAS E OBRAS ---

    async function carregarEmpresas() {
        try {
            const snapshot = await get(ref(db, 'empresas'));
            empresasCache = snapshot.exists() ? snapshot.val() : {};
            preencherSelectEmpresas();
        } catch (error) {
            console.error("Erro ao carregar empresas:", error);
        }
    }

    function preencherSelectEmpresas() {
        selectEmpresa.innerHTML = '<option value="">Nenhuma</option>';
        for (const id in empresasCache) {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = empresasCache[id].nome;
            selectEmpresa.appendChild(option);
        }
    }

    function atualizarSelectObras() {
        const empresaId = selectEmpresa.value;
        selectObra.innerHTML = ''; // Limpa as opções
        selectObra.disabled = true;

        if (!empresaId || !empresasCache[empresaId]?.obras) {
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = empresaId ? "Nenhuma obra cadastrada" : "Selecione uma empresa";
            selectObra.appendChild(defaultOption);
            return;
        }

        selectObra.disabled = false;
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = "Selecione a obra";
        selectObra.appendChild(defaultOption);

        const obras = empresasCache[empresaId].obras;
        for (const obraId in obras) {
            const option = document.createElement('option');
            option.value = obras[obraId].nome; // Salva o nome da obra
            option.textContent = obras[obraId].nome;
            selectObra.appendChild(option);
        }
    }
    
    // Evento para atualizar obras quando empresa muda
    selectEmpresa.addEventListener('change', atualizarSelectObras);

    // --- LÓGICA DE FUNCIONÁRIOS ---

    function toggleDiaristaCampos() {
        const tipo = document.querySelector('input[name="tipo"]:checked').value;
        diaristaCampos.style.display = tipo === 'diarista' ? 'block' : 'none';
    }
    document.querySelectorAll('input[name="tipo"]').forEach(radio => {
        radio.addEventListener('change', toggleDiaristaCampos);
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        btnSalvar.disabled = true;
        btnSalvar.textContent = "Salvando...";

        const tipo = document.querySelector('input[name="tipo"]:checked').value;
        const dadosFuncionario = {
            nome: form.nome.value.trim(),
            tipo: tipo,
            funcao: form.funcao.value.trim(),
            // Novos dados salvos
            empresaId: selectEmpresa.value,
            obra: selectObra.value,
        };

        if (tipo === 'diarista') {
            dadosFuncionario.cpf = form.cpf.value.trim();
            dadosFuncionario.valorDiaria = form.valorDiaria.value || 0;
        }

        try {
            const id = editandoId || Date.now();
            await set(ref(db, `funcionarios/${id}`), dadosFuncionario);
            showToast(editandoId ? 'Funcionário atualizado!' : 'Funcionário cadastrado!');
            resetarFormulario();
            await carregarFuncionarios();
        } catch (error) {
            console.error('Erro ao salvar:', error);
            showToast('Erro ao salvar funcionário', 'error');
        } finally {
            btnSalvar.disabled = false;
            btnSalvar.textContent = "Salvar";
        }
    });
    
    async function carregarFuncionarios() {
        try {
            const snapshot = await get(ref(db, 'funcionarios'));
            funcionariosCache = snapshot.exists() ? snapshot.val() : {};
            montarLista();
        } catch (error) {
            console.error('Erro ao carregar funcionários:', error);
        }
    }
    
    function montarLista() {
        listaFuncionarios.innerHTML = '';
        if (Object.keys(funcionariosCache).length === 0) {
            listaFuncionarios.innerHTML = `<div class="card" style="text-align:center; color: var(--text-secondary);"><p>Nenhum funcionário cadastrado.</p></div>`;
            return;
        }

        for (const id in funcionariosCache) {
            const f = funcionariosCache[id];
            const card = document.createElement('div');
            card.className = 'card';
            card.style.marginBottom = '16px';
            
            const empresaNome = f.empresaId ? empresasCache[f.empresaId]?.nome || 'N/A' : 'Nenhuma';

            card.innerHTML = `
                <h3 class="card-title" style="font-size: 1.1rem;">${f.nome}</h3>
                <div class="funcionario-details">
                    <p><strong>Tipo:</strong> ${f.tipo === 'diarista' ? 'Diarista' : 'Funcionário'}</p>
                    <p><strong>Função:</strong> ${f.funcao || '-'}</p>
                    <p><strong>Empresa:</strong> ${empresaNome}</p>
                    <p><strong>Obra:</strong> ${f.obra || 'Nenhuma'}</p>
                    ${f.tipo === 'diarista' ? `<p><strong>CPF:</strong> ${formatarCPF(f.cpf)}</p><p><strong>Valor/diária:</strong> R$ ${parseFloat(f.valorDiaria || 0).toFixed(2)}</p>` : ''}
                </div>
                <div class="funcionario-actions">
                    <button class="btn btn-secondary">Editar</button>
                    <button class="btn" style="background-color: var(--danger)">Excluir</button>
                </div>
            `;

            card.querySelector('.btn-secondary').addEventListener('click', () => editarFuncionario(id));
            card.querySelector('.btn[style*="--danger"]').addEventListener('click', () => excluirFuncionario(id));

            listaFuncionarios.appendChild(card);
        }
    }

    function editarFuncionario(id) {
        const f = funcionariosCache[id];
        if (!f) return;

        editandoId = id;
        formTitle.textContent = 'Editar Funcionário';
        btnSalvar.textContent = 'Atualizar';
        btnCancelarEdicao.style.display = 'inline-block';

        form.nome.value = f.nome;
        document.querySelector(`input[name="tipo"][value="${f.tipo}"]`).checked = true;
        toggleDiaristaCampos();
        form.funcao.value = f.funcao || '';
        form.cpf.value = f.cpf || '';
        form.valorDiaria.value = f.valorDiaria || '';
        
        // Preenche empresa e obra
        selectEmpresa.value = f.empresaId || '';
        atualizarSelectObras(); // Popula as obras da empresa
        
        // Atraso para garantir que as opções de obra foram carregadas
        setTimeout(() => {
            selectObra.value = f.obra || '';
        }, 100);

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function excluirFuncionario(id) {
        if (!confirm(`Deseja realmente excluir "${funcionariosCache[id].nome}"?`)) return;
        try {
            await remove(ref(db, `funcionarios/${id}`));
            showToast('Funcionário excluído!');
            await carregarFuncionarios();
        } catch (error) {
            console.error('Erro ao excluir:', error);
            showToast('Erro ao excluir', 'error');
        }
    }
    
    function resetarFormulario() {
        form.reset();
        editandoId = null;
        formTitle.textContent = 'Cadastrar Funcionário';
        btnSalvar.textContent = 'Salvar';
        btnCancelarEdicao.style.display = 'none';
        toggleDiaristaCampos();
        selectEmpresa.value = '';
        atualizarSelectObras();
    }
    
    btnCancelarEdicao.addEventListener('click', resetarFormulario);
    document.getElementById('cpf').addEventListener('input', e => {
      e.target.value = formatarCPF(e.target.value);
    });

    async function iniciar() {
        toggleDiaristaCampos();
        await carregarEmpresas(); // Carrega empresas primeiro
        await carregarFuncionarios(); // Depois carrega funcionários para ter os nomes das empresas
    }

    iniciar();
  </script>
</body>
</html>
