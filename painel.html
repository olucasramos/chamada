<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Painel de Acompanhamento - Controle de Presenças</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root {
    --accent: #2ecc71;
    --info: #3498db;
    --warning: #f59e0b;
    --text-primary: #ffffff;
    --text-secondary: rgba(255, 255, 255, 0.7);
    --border-radius: 12px;
    --transition: all 0.3s ease;
    --card-bg: rgba(42, 60, 80, 0.8);
    --input-bg: rgba(0, 0, 0, 0.2);
    --border-color: rgba(255, 255, 255, 0.1);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html { scroll-behavior: smooth; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background-color: #1f2937;
    color: var(--text-primary);
    margin: 0;
    min-height: 100vh;
    padding: 20px 15px 100px 15px;
  }
  .container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }
  header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
  }
  .btn-voltar {
    display: flex; align-items: center; gap: 8px;
    background-color: rgba(255, 255, 255, 0.1);
    color: var(--text-primary); text-decoration: none;
    padding: 10px 16px; border-radius: var(--border-radius);
    font-weight: 600; transition: var(--transition);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  .btn-voltar:hover { background-color: rgba(255, 255, 255, 0.2); }
  .header-title { font-size: 1.5rem; font-weight: 700; text-align: left; flex-grow: 1; }
  .card {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 24px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .card-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 20px;
    color: var(--text-primary);
  }
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    align-items: end;
  }
  .form-group { margin-bottom: 8px; }
  .form-label {
    display: block; font-size: 0.8rem; font-weight: 500;
    margin-bottom: 6px; color: var(--text-secondary); text-transform: uppercase;
  }
  .form-input, .form-select {
    width: 100%; padding: 12px 14px; border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background-color: var(--input-bg);
    color: var(--text-primary); font-size: 1rem;
    transition: var(--transition);
  }
  
  .dashboard-main-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 24px;
  }
  .metric-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 16px;
  }
  .metric-item { text-align: left; }
  .metric-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent);
  }
  .metric-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
  }
  .ranking-list {
      list-style: none;
      padding: 0;
      font-size: 0.9rem;
      margin-top: 8px;
  }
  .ranking-list li {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid var(--border-color);
  }
  .ranking-list li:last-child { border-bottom: none; }
  .ranking-list .value { font-weight: 600; }
  .ranking-list-placeholder {
      color: var(--text-secondary);
      font-style: italic;
  }
  #custom-date-filters {
    display: none;
    grid-column: 1 / -1;
  }
  canvas {
      margin-top: 16px;
      max-height: 250px;
      width: 100% !important;
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <a href="index.html" class="btn-voltar"><span>←</span> Voltar</a>
    <h1 class="header-title">Painel de Acompanhamento</h1>
  </header>

  <div class="card">
    <div class="form-grid">
      <div class="form-group">
        <label for="filtroPeriodo" class="form-label">Período</label>
        <select id="filtroPeriodo" class="form-select">
          <option value="hoje">Hoje</option>
          <option value="7dias">Últimos 7 dias</option>
          <option value="mes_atual" selected>Este Mês</option>
          <option value="folha_ponto">Folha de Ponto (26 a 25)</option>
          <option value="custom">Período Customizado</option>
        </select>
      </div>
      <div class="form-group">
        <label for="filtroEmpresa" class="form-label">Empresa</label>
        <select id="filtroEmpresa" class="form-select">
          <option value="todas">Todas as Empresas</option>
        </select>
      </div>
      <div class="form-group">
        <label for="filtroObra" class="form-label">Obra</label>
        <select id="filtroObra" class="form-select" disabled>
          <option value="todas">Todas as Obras</option>
        </select>
      </div>
      <div id="custom-date-filters" class="form-grid">
        <div class="form-group">
          <label for="dataInicio" class="form-label">Data Início</label>
          <input type="date" id="dataInicio" class="form-input">
        </div>
        <div class="form-group">
          <label for="dataFim" class="form-label">Data Fim</label>
          <input type="date" id="dataFim" class="form-input">
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard-main-grid">
    
    <div class="card">
      <h2 class="card-title">Custos com Diaristas</h2>
      <div class="metric-container" style="grid-template-columns: 1fr 1fr; display: grid;">
        <div class="metric-item">
          <span class="metric-value" id="custo-pago">R$ 0,00</span>
          <span class="metric-label">Valor Total Pago</span>
        </div>
        <div class="metric-item">
          <span class="metric-value" id="custo-pendente" style="color: var(--warning);">R$ 0,00</span>
          <span class="metric-label">Valor Total a Pagar</span>
        </div>
        <div class="metric-item">
          <span class="metric-value" id="diarias-pagas">0</span>
          <span class="metric-label">Diárias Pagas (Qtd)</span>
        </div>
        <div class="metric-item">
          <span class="metric-value" id="diarias-pendentes" style="color: var(--warning);">0</span>
          <span class="metric-label">Diárias a Pagar (Qtd)</span>
        </div>
      </div>
      <canvas id="graficoCustoDiario"></canvas>
    </div>

    <div class="card">
      <h2 class="card-title">Acompanhamento de Horas Extras</h2>
      <div class="metric-container" style="grid-template-columns: 1fr 1fr 1fr; display: grid;">
          <div class="metric-item">
              <span class="metric-value" id="he-total">0h</span>
              <span class="metric-label">Total de Horas</span>
            </div>
        <div class="metric-item">
          <span class="metric-value" id="he-50">0h</span>
          <span class="metric-label">Horas a 50%</span>
        </div>
        <div class="metric-item">
          <span class="metric-value" id="he-100">0h</span>
          <span class="metric-label">Horas a 100%</span>
        </div>
      </div>
      <h3 style="font-size: 0.9rem; font-weight: 600; margin-top: 16px;">Top 3 Funcionários com Mais Horas Extras</h3>
      <ul class="ranking-list" id="ranking-he-funcionarios">
        <li class="ranking-list-placeholder">Nenhum funcionário encontrado.</li>
      </ul>
    </div>

    <div class="card">
      <h2 class="card-title">Controle de Frequência</h2>
      <div class="metric-container">
        <div class="metric-item">
          <span class="metric-value" id="taxa-assiduidade">0%</span>
          <span class="metric-label">Taxa de Assiduidade</span>
        </div>
      </div>
      <canvas id="graficoFaltas"></canvas>
      <h3 style="font-size: 0.9rem; font-weight: 600; margin-top: 16px;">Ranking de Faltas (Sem Atestado)</h3>
      <ul class="ranking-list" id="ranking-faltas-sem-atestado">
          <li class="ranking-list-placeholder">Nenhuma falta encontrada.</li>
      </ul>
    </div>

    <div class="card">
      <h2 class="card-title">Análise de Mão de Obra</h2>
      <h3 style="font-size: 0.9rem; font-weight: 600;">Horas Extras por Função</h3>
      <canvas id="graficoHEFuncao"></canvas>
      <h3 style="font-size: 0.9rem; font-weight: 600; margin-top: 16px;">Distribuição de Funções em Campo</h3>
       <canvas id="graficoDistFuncoes"></canvas>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
      <h2 class="card-title">Efetivo Diário Presente no Período</h2>
      <canvas id="graficoEfetivoDiario"></canvas>
    </div>

  </div>
</div>

<script type="module">
  import { db, ref, get } from "./firebase.js";
  
  let empresasCache = {}, funcionariosCache = {}, chamadasCache = {}, horasExtrasCache = {};
  let charts = {};

  const filtroPeriodo = document.getElementById('filtroPeriodo');
  const filtroEmpresa = document.getElementById('filtroEmpresa');
  const filtroObra = document.getElementById('filtroObra');
  const customDateFilters = document.getElementById('custom-date-filters');
  const dataInicioInput = document.getElementById('dataInicio');
  const dataFimInput = document.getElementById('dataFim');


  async function carregarDadosIniciais() {
    try {
      const [empresasSnap, funcionariosSnap, chamadasSnap, heSnap] = await Promise.all([
        get(ref(db, 'empresas')), get(ref(db, 'funcionarios')),
        get(ref(db, 'chamadas')), get(ref(db, 'horaextra'))
      ]);
      empresasCache = empresasSnap.exists() ? empresasSnap.val() : {};
      funcionariosCache = funcionariosSnap.exists() ? funcionariosSnap.val() : {};
      chamadasCache = chamadasSnap.exists() ? chamadasSnap.val() : {};
      horasExtrasCache = heSnap.exists() ? heSnap.val() : {};
      
      popularFiltroEmpresas();
      aplicarFiltros();
    } catch (error) {
      console.error("Erro fatal ao carregar dados:", error);
      alert("Não foi possível carregar os dados do painel.");
    }
  }

  function popularFiltroEmpresas() {
    filtroEmpresa.innerHTML = '<option value="todas">Todas as Empresas</option>';
    Object.keys(empresasCache).sort((a,b) => empresasCache[a].nome.localeCompare(empresasCache[b].nome))
      .forEach(id => {
        filtroEmpresa.innerHTML += `<option value="${id}">${empresasCache[id].nome}</option>`;
      });
  }
  
  function atualizarFiltroObras() {
      const empresaId = filtroEmpresa.value;
      filtroObra.innerHTML = '<option value="todas">Todas as Obras</option>';
      filtroObra.disabled = true;
      if (empresaId !== 'todas' && empresasCache[empresaId]?.obras) {
          filtroObra.disabled = false;
          Object.values(empresasCache[empresaId].obras).sort((a,b) => a.nome.localeCompare(b.nome))
            .forEach(obra => {
              filtroObra.innerHTML += `<option value="${obra.nome}">${obra.nome}</option>`;
            });
      }
  }

  function aplicarFiltros() {
    const { inicio, fim } = getIntervaloDeDatas();
    if (!inicio || !fim) {
        if (filtroPeriodo.value === 'custom') alert("Por favor, selecione as datas de início e fim.");
        return;
    }
    const empresaId = filtroEmpresa.value;
    const obraNome = filtroObra.value;
    
    const dadosFiltrados = filtrarDadosGerais(inicio, fim, empresaId, obraNome);
    
    atualizarCardCustos(dadosFiltrados.chamadas);
    atualizarCardHE(dadosFiltrados.horasExtras);
    atualizarCardFrequencia(dadosFiltrados.chamadas, inicio, fim);
    atualizarCardMaoDeObra(dadosFiltrados.chamadas, dadosFiltrados.horasExtras);
    atualizarCardEfetivo(dadosFiltrados.chamadas, inicio, fim);
  }
  
  function getIntervaloDeDatas() {
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    let inicio = new Date(hoje);
    let fim = new Date(hoje);
    const periodo = filtroPeriodo.value;

    if (periodo === 'custom') {
        return { inicio: dataInicioInput.value, fim: dataFimInput.value };
    }

    switch (periodo) {
      case '7dias': inicio.setDate(hoje.getDate() - 6); break;
      case 'mes_atual':
        inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        fim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
        break;
      case 'folha_ponto':
        const diaAtual = hoje.getDate();
        if (diaAtual >= 26) {
          inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 26);
          fim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 25);
        } else {
          inicio = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 26);
          fim = new Date(hoje.getFullYear(), hoje.getMonth(), 25);
        }
        break;
    }
    const paraISO = (data) => data.toISOString().split('T')[0];
    return { inicio: paraISO(inicio), fim: paraISO(fim) };
  }
  
  function filtrarDadosGerais(inicio, fim, empresaId, obraNome) {
      const chamadasFiltradas = {}, horasExtrasFiltradas = {};
      const filtrar = (cache, resultado) => {
          for (const data in cache) {
              if (data >= inicio && data <= fim) {
                  iterarRegistros({[data]: cache[data]}, (d, eId, oNome, fId, reg) => {
                      if ((empresaId === 'todas' || eId === empresaId) && (obraNome === 'todas' || oNome === obraNome)) {
                          if (!resultado[d]) resultado[d] = {};
                          if (!resultado[d][eId]) resultado[d][eId] = {};
                          if (!resultado[d][eId][encodeURIComponent(oNome)]) resultado[d][eId][encodeURIComponent(oNome)] = {};
                          resultado[d][eId][encodeURIComponent(oNome)][fId] = reg;
                      }
                  });
              }
          }
      };
      filtrar(chamadasCache, chamadasFiltradas);
      filtrar(horasExtrasCache, horasExtrasFiltradas);
      return { chamadas: chamadasFiltradas, horasExtras: horasExtrasFiltradas };
  }
  
  function atualizarCardCustos(chamadas) {
    let valorPago = 0, valorPendente = 0, qtdPagas = 0, qtdPendentes = 0;
    const custoPorDia = {};
    iterarRegistros(chamadas, (data, empId, obNome, funcId, registro) => {
        const func = funcionariosCache[funcId];
        if (func?.tipo === 'diarista' && registro.status === 'presente') {
            const valor = parseFloat(func.valorDiaria) || 0;
            if (registro.pago) { valorPago += valor; qtdPagas++; } 
            else { valorPendente += valor; qtdPendentes++; }
            custoPorDia[data] = (custoPorDia[data] || 0) + valor;
        }
    });
    document.getElementById('custo-pago').textContent = `R$ ${valorPago.toFixed(2)}`;
    document.getElementById('custo-pendente').textContent = `R$ ${valorPendente.toFixed(2)}`;
    document.getElementById('diarias-pagas').textContent = qtdPagas;
    document.getElementById('diarias-pendentes').textContent = qtdPendentes;
    
    const sortedDates = Object.keys(custoPorDia).sort();
    renderChart('graficoCustoDiario', 'bar', {
        labels: sortedDates.map(d => d.substring(5).split('-').reverse().join('/')),
        datasets: [{ data: sortedDates.map(d => custoPorDia[d]) }]
    }, { title: 'Custo Diário com Diaristas (R$)' });
  }

  function atualizarCardHE(horasExtras) {
      let total = 0, h50 = 0, h100 = 0;
      const hePorFunc = {};
      iterarRegistros(horasExtras, (data, empId, obNome, funcId, registro) => {
          const qtd = parseInt(registro.quantidadeHoras) || 0;
          total += qtd;
          if (registro.percentual === '50') h50 += qtd; else h100 += qtd;
          const nomeFunc = funcionariosCache[funcId]?.nome || 'Desconhecido';
          hePorFunc[nomeFunc] = (hePorFunc[nomeFunc] || 0) + qtd;
      });
      document.getElementById('he-total').textContent = `${total}h`;
      document.getElementById('he-50').textContent = `${h50}h`;
      document.getElementById('he-100').textContent = `${h100}h`;
      renderRanking('ranking-he-funcionarios', hePorFunc, 'h', 'Nenhum funcionário com HE.');
  }
  
  function atualizarCardFrequencia(chamadas, inicio, fim) {
      let faltasCom = 0, faltasSem = 0, presencas = 0;
      const faltasPorFunc = {};
      iterarRegistros(chamadas, (data, empId, obNome, funcId, registro) => {
          if (funcionariosCache[funcId]?.tipo !== 'funcionario') return;
          if(registro.status === 'presente') presencas++;
          if(registro.status === 'falta') {
              if(registro.atestado) faltasCom++; else {
                  faltasSem++;
                  const nomeFunc = funcionariosCache[funcId]?.nome || 'Desconhecido';
                  faltasPorFunc[nomeFunc] = (faltasPorFunc[nomeFunc] || 0) + 1;
              }
          }
      });
      const numFuncionarios = Object.keys(funcionariosCache).filter(id => funcionariosCache[id].tipo === 'funcionario').length;
      const diasPossiveis = numFuncionarios * diasUteisNoPeriodo(inicio, fim);
      const taxa = diasPossiveis > 0 ? (presencas / diasPossiveis) * 100 : 0;
      document.getElementById('taxa-assiduidade').textContent = `${taxa.toFixed(1)}%`;
      renderRanking('ranking-faltas-sem-atestado', faltasPorFunc, ' dias', 'Nenhuma falta sem atestado.');
      renderChart('graficoFaltas', 'pie', {
          labels: ['Com Atestado', 'Sem Atestado'],
          datasets: [{ data: [faltasCom, faltasSem], backgroundColor: ['#3498db', '#e74c3c'] }]
      }, { title: 'Proporção de Faltas' });
  }

  function atualizarCardMaoDeObra(chamadas, horasExtras) {
      const hePorFuncao = {}, distFuncoes = {};
      iterarRegistros(horasExtras, (d,e,o,funcId,reg) => {
          const func = funcionariosCache[funcId];
          if(func?.funcao) hePorFuncao[func.funcao] = (hePorFuncao[func.funcao] || 0) + (parseInt(reg.quantidadeHoras) || 0);
      });
      iterarRegistros(chamadas, (d,e,o,funcId,reg) => {
          const func = funcionariosCache[funcId];
          if(func?.funcao && reg.status === 'presente') distFuncoes[func.funcao] = (distFuncoes[func.funcao] || 0) + 1;
      });
      renderChart('graficoHEFuncao', 'bar', {
        labels: Object.keys(hePorFuncao),
        datasets: [{ data: Object.values(hePorFuncao) }]
      }, { title: 'Horas Extras por Função', legendDisplay: false });
      renderChart('graficoDistFuncoes', 'doughnut', {
        labels: Object.keys(distFuncoes),
        datasets: [{ data: Object.values(distFuncoes), backgroundColor: ['#1abc9c', '#f1c40f', '#e67e22', '#34495e', '#95a5a6', '#7f8c8d'] }]
      }, { title: 'Funções Mais Presentes' });
  }
  
  function atualizarCardEfetivo(chamadas, inicio, fim) {
      const efetivoPorDia = {};
      let d = new Date(inicio + 'T12:00:00'), dFim = new Date(fim + 'T12:00:00');
      while(d <= dFim) {
          const dataISO = d.toISOString().split('T')[0];
          efetivoPorDia[dataISO] = 0;
          d.setDate(d.getDate() + 1);
      }
      iterarRegistros(chamadas, (data, e, o, f, reg) => {
          if(reg.status === 'presente' && efetivoPorDia[data] !== undefined) efetivoPorDia[data]++;
      });
      const sortedDates = Object.keys(efetivoPorDia).sort();
      renderChart('graficoEfetivoDiario', 'line', {
          labels: sortedDates.map(d => d.substring(5).split('-').reverse().join('/')),
          datasets: [{ data: sortedDates.map(d => efetivoPorDia[d]), borderColor: '#3498db', tension: 0.1 }]
      }, { title: 'Funcionários Presentes por Dia', legendDisplay: false });
  }

  /**
   * MODIFICADO: Esta função agora entende os dois formatos de dados (antigo e novo)
   * para garantir a compatibilidade com o histórico do sistema.
   */
  function iterarRegistros(dados, callback) {
      for (const data in dados) {
          const registrosDoDia = dados[data];
          if (!registrosDoDia || Object.keys(registrosDoDia).length === 0) continue;

          const primeiroId = Object.keys(registrosDoDia)[0];
          const éFormatoAntigo = registrosDoDia[primeiroId]?.status !== undefined || registrosDoDia[primeiroId]?.percentual !== undefined;

          if (éFormatoAntigo) {
              for (const funcId in registrosDoDia) {
                  const registro = registrosDoDia[funcId];
                  const funcionario = funcionariosCache[funcId];
                  if (funcionario) {
                      const empId = funcionario.empresaId || 'sem_empresa';
                      const obraNome = funcionario.obra || 'sem_obra';
                      callback(data, empId, obraNome, funcId, registro);
                  }
              }
          } else {
              for (const empId in registrosDoDia) {
                  for (const obNomeCodificado in registrosDoDia[empId]) {
                      for (const funcId in registrosDoDia[empId][obNomeCodificado]) {
                          const registro = registrosDoDia[empId][obNomeCodificado][funcId];
                          callback(data, empId, decodeURIComponent(obNomeCodificado), funcId, registro);
                      }
                  }
              }
          }
      }
  }

  function renderRanking(elementId, dados, sufixo, mensagemVazia) {
      const container = document.getElementById(elementId);
      container.innerHTML = '';
      const ranking = Object.entries(dados).sort(([,a],[,b]) => b - a).slice(0, 3);
      if(ranking.length === 0) {
          container.innerHTML = `<li class="ranking-list-placeholder">${mensagemVazia}</li>`;
          return;
      }
      ranking.forEach(([nome, valor]) => {
          container.innerHTML += `<li><span>${nome}</span><span class="value">${valor}${sufixo}</span></li>`;
      });
  }
  
  function renderChart(canvasId, type, data, customOptions = {}) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (charts[canvasId]) charts[canvasId].destroy();
    
    Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif";
    Chart.defaults.color = 'rgba(255, 255, 255, 0.7)';

    const defaultOptions = {
        responsive: true, maintainAspectRatio: false,
        plugins: {
            legend: { display: customOptions.legendDisplay !== false, labels: { color: 'rgba(255, 255, 255, 0.8)' }},
            title: { display: !!customOptions.title, text: customOptions.title, color: 'rgba(255, 255, 255, 0.9)', font: { size: 14 }},
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.7)', titleFont: { size: 14 }, bodyFont: { size: 12 }
            }
        },
        scales: { 
            x: { ticks: { color: 'rgba(255, 255, 255, 0.7)' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }}, 
            y: { beginAtZero: true, ticks: { color: 'rgba(255, 255, 255, 0.7)' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }}
        },
        layout: { padding: 10 }
    };
    
    if (type === 'pie' || type === 'doughnut') {
        delete defaultOptions.scales;
    }
    
    charts[canvasId] = new Chart(ctx, { type, data, options: defaultOptions });
  }
  
  function diasUteisNoPeriodo(inicio, fim) {
    let count = 0;
    const curDate = new Date(inicio + 'T12:00:00'), fimDate = new Date(fim + 'T12:00:00');
    while (curDate <= fimDate) {
        const dayOfWeek = curDate.getDay();
        if (dayOfWeek !== 0 && dayOfWeek !== 6) count++;
        curDate.setDate(curDate.getDate() + 1);
    }
    return count > 0 ? count : 1;
  }
  
  function handlePeriodoChange() {
      if (filtroPeriodo.value === 'custom') {
          customDateFilters.style.display = 'grid';
          const hoje = new Date().toISOString().split('T')[0];
          if(!dataInicioInput.value) dataInicioInput.value = hoje;
          if(!dataFimInput.value) dataFimInput.value = hoje;
      } else {
          customDateFilters.style.display = 'none';
      }
      aplicarFiltros();
  }

  filtroEmpresa.addEventListener('change', () => {
    atualizarFiltroObras();
    aplicarFiltros();
  });
  filtroPeriodo.addEventListener('change', handlePeriodoChange);
  filtroObra.addEventListener('change', aplicarFiltros);
  dataInicioInput.addEventListener('change', aplicarFiltros);
  dataFimInput.addEventListener('change', aplicarFiltros);

  document.addEventListener('DOMContentLoaded', carregarDadosIniciais);
</script>

</body>
</html>
